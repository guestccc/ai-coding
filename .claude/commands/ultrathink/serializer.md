# ä¼šè¯åºåˆ—åŒ–å™¨ (Session Serializer)

## èŒè´£æ¦‚è¿°
è´Ÿè´£ä¼šè¯çŠ¶æ€çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–ã€å‹ç¼©ã€è§£å‹ç¼©ç­‰æ•°æ®è½¬æ¢æ“ä½œï¼Œç¡®ä¿ä¼šè¯æ•°æ®çš„é«˜æ•ˆå­˜å‚¨å’Œå‡†ç¡®æ¢å¤ã€‚

## åºåˆ—åŒ–ç­–ç•¥

### 1. åˆ†å±‚åºåˆ—åŒ–æ¶æ„
```yaml
L1-å…ƒæ•°æ®å±‚: ä¼šè¯åŸºæœ¬ä¿¡æ¯ï¼ˆIDã€æ—¶é—´ã€æ¨¡å¼ç­‰ï¼‰
L2-çŠ¶æ€å±‚: é¡¹ç›®è¿›åº¦ã€ä»»åŠ¡å®ŒæˆçŠ¶æ€
L3-ä¸Šä¸‹æ–‡å±‚: æ–‡ä»¶å¼•ç”¨ã€å†³ç­–è®°å½•ã€é—®é¢˜æ¸…å•
L4-å†…å®¹å±‚: å…·ä½“æ–‡ä»¶å†…å®¹ã€ä»£ç ç‰‡æ®µ
L5-ç¼“å­˜å±‚: Agentè¾“å‡ºã€ä¸´æ—¶æ•°æ®
```

### 2. æ•°æ®ç»“æ„æ˜ å°„
```json
{
  "meta": {
    "version": "1.3.0",
    "timestamp": "2024-01-01T12:00:00Z",
    "compression": "lz4",
    "encoding": "utf-8"
  },
  "session": {
    "id": "ut-session-xxx",
    "project": "é¡¹ç›®åç§°",
    "mode": "standard",
    "stage": "T8/20"
  },
  "context": {
    "compressed": true,
    "algorithm": "reference-substitution",
    "data": "å‹ç¼©åçš„ä¸Šä¸‹æ–‡æ•°æ®",
    "references": {
      "@PRD": "docs/PRD.md",
      "@arch": "docs/architecture.md",
      "@api": "docs/openapi.yaml"
    }
  },
  "checksum": "sha256-hash"
}
```

## æ™ºèƒ½å‹ç¼©ç®—æ³•

### 1. å¼•ç”¨æ›¿æ¢å‹ç¼© (Reference Substitution)
```yaml
åŸç†: å°†é‡å¤å‡ºç°çš„é•¿æ–‡æœ¬æ›¿æ¢ä¸ºçŸ­å¼•ç”¨æ ‡è¯†

ç¤ºä¾‹è½¬æ¢:
åŸæ–‡: "æ ¹æ®docs/PRD.mdæ–‡ä»¶ä¸­çš„ç”¨æˆ·è®¤è¯éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°JWTè®¤è¯ç³»ç»Ÿ"
å‹ç¼©: "æ ¹æ®@PRDä¸­çš„ç”¨æˆ·è®¤è¯éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°@JWTè®¤è¯ç³»ç»Ÿ"
å¼•ç”¨è¡¨: 
  "@PRD": "docs/PRD.mdæ–‡ä»¶"
  "@JWT": "JWT"

å‹ç¼©æ•ˆæœ:
  åŸæ–‡é•¿åº¦: 47å­—ç¬¦
  å‹ç¼©å: 28å­—ç¬¦
  å‹ç¼©ç‡: 40%
```

### 2. è¯­ä¹‰ç›¸ä¼¼åº¦èšç±»å‹ç¼©
```yaml
ç®—æ³•: å°†è¯­ä¹‰ç›¸ä¼¼çš„å†…å®¹èšç±»ï¼Œç”¨ä»£è¡¨æ€§æè¿°æ›¿ä»£

èšç±»ç¤ºä¾‹:
åŸæ–‡:
  - "å‰ç«¯Reactç»„ä»¶å¼€å‘"
  - "Reactå‰ç«¯ç»„ä»¶å®ç°"  
  - "å¼€å‘Reactç•Œé¢ç»„ä»¶"
  
å‹ç¼©: "@FE-Component-Dev" (3ä¸ªå˜ä½“ â†’ 1ä¸ªå¼•ç”¨)
å‹ç¼©ç‡: 75%
```

### 3. ä¸Šä¸‹æ–‡çª—å£ä¼˜åŒ–å‹ç¼©
```yaml
ç­–ç•¥: æ ¹æ®å½“å‰ä»»åŠ¡ç›¸å…³æ€§åŠ¨æ€è°ƒæ•´å†…å®¹è¯¦ç»†ç¨‹åº¦

ç›¸å…³æ€§æƒé‡:
  - å½“å‰ä»»åŠ¡ç›´æ¥ç›¸å…³: 100% (ä¿æŒåŸå§‹)
  - è¿‘æœŸä»»åŠ¡ç›¸å…³: 70% (é€‚åº¦å‹ç¼©)
  - å†å²ä»»åŠ¡ç›¸å…³: 40% (é«˜åº¦å‹ç¼©)
  - æ— å…³å†…å®¹: 10% (ä»…ä¿ç•™å¼•ç”¨)
```

## Tokenä¼˜åŒ–æŠ€æœ¯

### 1. ç¬¦å·åŒ–æ˜ å°„è¡¨
```yaml
# æŠ€æœ¯æœ¯è¯­æ˜ å°„
æŠ€æœ¯æ ˆæ˜ å°„:
  "Reactå‰ç«¯åº”ç”¨": "@React"
  "Expressåç«¯æœåŠ¡": "@Express"  
  "PostgreSQLæ•°æ®åº“": "@PG"
  "TypeScriptç±»å‹æ£€æŸ¥": "@TS"
  "Prisma ORM": "@Prisma"

æ“ä½œæ˜ å°„:
  "å¢åˆ æ”¹æŸ¥": "@CRUD"
  "ç”¨æˆ·è®¤è¯": "@Auth"
  "æƒé™ç®¡ç†": "@Permission"
  "æ•°æ®éªŒè¯": "@Validate"
  "é”™è¯¯å¤„ç†": "@Error"

çŠ¶æ€æ˜ å°„:
  "å·²å®Œæˆ": "âœ“"
  "è¿›è¡Œä¸­": "ğŸ”„"
  "å¾…å¼€å§‹": "â³"
  "æœ‰é—®é¢˜": "âš ï¸"
```

### 2. ç»“æ„åŒ–æ•°æ®å‹ç¼©
```yaml
# JSONç»“æ„ä¼˜åŒ–
åŸå§‹JSON:
{
  "taskId": "T8",
  "taskName": "åç«¯åŸºç¡€æ¶æ„",
  "status": "completed",
  "startTime": "2024-01-01T10:00:00Z",
  "endTime": "2024-01-01T12:00:00Z"
}

å‹ç¼©JSON:
{
  "id": "T8",
  "name": "@BEåŸºç¡€",
  "status": "âœ“", 
  "time": ["10:00", "12:00"]
}

å‹ç¼©ç‡: 62%
```

### 3. å¢é‡åºåˆ—åŒ–ç­–ç•¥
```yaml
# åªåºåˆ—åŒ–å˜æ›´éƒ¨åˆ†
å¢é‡è®°å½•æ ¼å¼:
{
  "baseSnapshot": "checkpoint-T7",
  "delta": {
    "added": ["æ–°å¢çš„ä»»åŠ¡T8"],
    "modified": ["ä¿®æ”¹çš„é…ç½®é¡¹"],
    "deleted": ["åˆ é™¤çš„ä¸´æ—¶æ–‡ä»¶"]
  },
  "deltaSize": "2.3KB"
}

å…¨é‡é‡å»ºè§¦å‘æ¡ä»¶:
  - å¢é‡ç´¯è®¡å¤§å° > 10KB
  - å¢é‡è®°å½•æ•° > 50æ¡
  - è·ç¦»ä¸Šæ¬¡å…¨é‡ > 24å°æ—¶
```

## åºåˆ—åŒ–å®ç°

### 1. æ ¸å¿ƒåºåˆ—åŒ–å‡½æ•°
```javascript
// ä¼ªä»£ç ç¤ºä¾‹
class SessionSerializer {
  serialize(sessionState) {
    // 1. æå–å…ƒæ•°æ®
    const meta = this.extractMetadata(sessionState);
    
    // 2. å‹ç¼©ä¸Šä¸‹æ–‡
    const compressedContext = this.compressContext(
      sessionState.context
    );
    
    // 3. æ„å»ºå¼•ç”¨æ˜ å°„
    const references = this.buildReferenceMap(compressedContext);
    
    // 4. ç”Ÿæˆæ ¡éªŒå’Œ
    const checksum = this.generateChecksum(data);
    
    return {
      meta,
      session: sessionState.core,
      context: {
        compressed: true,
        data: compressedContext,
        references
      },
      checksum
    };
  }
  
  deserialize(serializedData) {
    // 1. éªŒè¯æ ¡éªŒå’Œ
    this.verifyChecksum(serializedData);
    
    // 2. è§£å‹ç¼©ä¸Šä¸‹æ–‡
    const context = this.decompressContext(
      serializedData.context.data,
      serializedData.context.references
    );
    
    // 3. é‡å»ºä¼šè¯çŠ¶æ€
    return this.rebuildSessionState(
      serializedData.session,
      context
    );
  }
}
```

### 2. ä¸Šä¸‹æ–‡å‹ç¼©å‡½æ•°
```javascript
// ä¸Šä¸‹æ–‡å‹ç¼©å®ç°
compressContext(context) {
  let compressed = context;
  
  // å¼•ç”¨æ›¿æ¢
  compressed = this.applyReferenceSubstitution(compressed);
  
  // ç¬¦å·åŒ–æ˜ å°„
  compressed = this.applySymbolMapping(compressed);
  
  // ç»“æ„ä¼˜åŒ–
  compressed = this.optimizeStructure(compressed);
  
  // ç®—æ³•å‹ç¼©
  compressed = this.algorithmicCompress(compressed);
  
  return compressed;
}
```

## æ•°æ®å®Œæ•´æ€§ä¿è¯

### 1. æ ¡éªŒå’Œæœºåˆ¶
```yaml
ç®—æ³•: SHA-256å“ˆå¸Œ
è¦†ç›–: æ‰€æœ‰åºåˆ—åŒ–æ•°æ®
éªŒè¯: ååºåˆ—åŒ–å‰å¿…é¡»éªŒè¯
å¤±è´¥å¤„ç†: æç¤ºæ•°æ®æŸåå¹¶å°è¯•ä¿®å¤
```

### 2. ç‰ˆæœ¬å…¼å®¹æ€§
```yaml
ç‰ˆæœ¬æ ‡è¯†: æ¯ä¸ªåºåˆ—åŒ–æ•°æ®åŒ…å«ç‰ˆæœ¬å·
å‘å‰å…¼å®¹: æ–°ç‰ˆæœ¬å¯è¯»å–æ—§ç‰ˆæœ¬æ•°æ®
å‘åå…¼å®¹: ä½¿ç”¨é™çº§åºåˆ—åŒ–ç¡®ä¿å…¼å®¹æ€§
è¿ç§»æœºåˆ¶: è‡ªåŠ¨å‡çº§æ—§ç‰ˆæœ¬æ ¼å¼
```

### 3. é”™è¯¯æ¢å¤æœºåˆ¶
```yaml
å¤‡ä»½ç­–ç•¥: æ¯æ¬¡åºåˆ—åŒ–å‰åˆ›å»ºå¤‡ä»½
æŸåæ£€æµ‹: ååºåˆ—åŒ–æ—¶è‡ªåŠ¨æ£€æµ‹æŸå
è‡ªåŠ¨ä¿®å¤: å°è¯•ä»å¤‡ä»½å’Œå¢é‡è®°å½•ä¿®å¤
ç”¨æˆ·ç¡®è®¤: ä¿®å¤å¤±è´¥æ—¶è¯·æ±‚ç”¨æˆ·ä»‹å…¥
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å»¶è¿Ÿåºåˆ—åŒ–
```yaml
è§¦å‘æ¡ä»¶:
  - ä¼šè¯çŠ¶æ€å‘ç”Ÿé‡è¦å˜æ›´
  - ç”¨æˆ·ä¸»åŠ¨ä¿å­˜è¯·æ±‚
  - ç³»ç»Ÿå®šæ—¶è‡ªåŠ¨ä¿å­˜
  
å»¶è¿Ÿç­–ç•¥:
  - å°å˜æ›´æ‰¹é‡å¤„ç†
  - é‡è¦å˜æ›´ç«‹å³å¤„ç†
  - ç©ºé—²æ—¶é—´æ‰¹é‡åºåˆ—åŒ–
```

### 2. å†…å­˜ç®¡ç†
```yaml
æµå¼å¤„ç†: å¤§æ–‡ä»¶åˆ†å—åºåˆ—åŒ–
å†…å­˜å¤ç”¨: ç¼“å†²åŒºé‡å¤ä½¿ç”¨
åƒåœ¾å›æ”¶: åŠæ—¶é‡Šæ”¾ä¸´æ—¶å¯¹è±¡
å†…å­˜ç›‘æ§: åºåˆ—åŒ–è¿‡ç¨‹å†…å­˜ä½¿ç”¨ç›‘æ§
```

### 3. å¹¶å‘å¤„ç†
```yaml
è¯»å†™åˆ†ç¦»: åºåˆ—åŒ–ä¸å½±å“è¯»å–æ“ä½œ
å¼‚æ­¥å¤„ç†: åºåˆ—åŒ–æ“ä½œå¼‚æ­¥æ‰§è¡Œ
é”æœºåˆ¶: é¿å…å¹¶å‘åºåˆ—åŒ–å†²çª
é˜Ÿåˆ—ç®¡ç†: åºåˆ—åŒ–ä»»åŠ¡é˜Ÿåˆ—åŒ–å¤„ç†
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬åºåˆ—åŒ–æ“ä½œ
```
# åºåˆ—åŒ–å½“å‰ä¼šè¯
ç³»ç»Ÿ: [åºåˆ—åŒ–å™¨] å¼€å§‹åºåˆ—åŒ–ä¼šè¯çŠ¶æ€...
      âœ“ å…ƒæ•°æ®æå–å®Œæˆ (127 bytes)
      âœ“ ä¸Šä¸‹æ–‡å‹ç¼©å®Œæˆ (23.4KB â†’ 12.1KB, 48%å‹ç¼©ç‡)
      âœ“ å¼•ç”¨æ˜ å°„æ„å»ºå®Œæˆ (15ä¸ªå¼•ç”¨)
      âœ“ æ•°æ®å®Œæ•´æ€§æ ¡éªŒé€šè¿‡
      ğŸ’¾ åºåˆ—åŒ–å®Œæˆ: session-T8-20240101.json (12.3KB)
```

### ååºåˆ—åŒ–æ¢å¤
```
# ååºåˆ—åŒ–å†å²ä¼šè¯  
ç³»ç»Ÿ: [åºåˆ—åŒ–å™¨] å¼€å§‹ååºåˆ—åŒ–ä¼šè¯...
      âœ“ æ•°æ®å®Œæ•´æ€§æ ¡éªŒé€šè¿‡
      âœ“ ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡ (v1.3.0)
      âœ“ å¼•ç”¨æ˜ å°„è§£æå®Œæˆ
      âœ“ ä¸Šä¸‹æ–‡è§£å‹ç¼©å®Œæˆ (12.1KB â†’ 23.4KB)
      âœ¨ ååºåˆ—åŒ–å®Œæˆ: ä¼šè¯çŠ¶æ€å·²æ¢å¤
```

### å‹ç¼©æ•ˆæœæŠ¥å‘Š
```
# å‹ç¼©ç»Ÿè®¡æŠ¥å‘Š
ğŸ“Š åºåˆ—åŒ–å‹ç¼©æŠ¥å‘Š:
   åŸå§‹å¤§å°: 48.7KB
   å‹ç¼©å: 21.3KB  
   å‹ç¼©ç‡: 56%
   
   å‹ç¼©åˆ†è§£:
   - å¼•ç”¨æ›¿æ¢: 28% (13.6KBèŠ‚çœ)
   - ç¬¦å·æ˜ å°„: 15% (7.3KBèŠ‚çœ)  
   - ç»“æ„ä¼˜åŒ–: 8% (3.9KBèŠ‚çœ)
   - ç®—æ³•å‹ç¼©: 5% (2.6KBèŠ‚çœ)
```

## é…ç½®é€‰é¡¹

### åºåˆ—åŒ–é…ç½®
```yaml
# .claude/ultrathink/session/serializer-config.json
{
  "compression": {
    "enabled": true,
    "algorithm": "hybrid",  # reference|symbol|hybrid
    "level": "balanced",    # fast|balanced|maximum  
    "minThreshold": 512     # å°äº512Bä¸å‹ç¼©
  },
  "references": {
    "maxReferences": 100,   # æœ€å¤š100ä¸ªå¼•ç”¨
    "minSavings": 10,       # è‡³å°‘èŠ‚çœ10å­—ç¬¦æ‰åˆ›å»ºå¼•ç”¨
    "commonPatterns": [     # é¢„å®šä¹‰å¸¸ç”¨æ¨¡å¼
      "docs/*.md",
      "src/**/*.ts",
      "@Agent-*"
    ]
  },
  "integrity": {
    "checksumAlgorithm": "sha256",
    "verifyOnLoad": true,
    "backupOnSave": true,
    "maxBackups": 5
  }
}
```

---

**ç‰ˆæœ¬**: v1.3.0  
**æœ€åæ›´æ–°**: 2024-01-01  
**ç»´æŠ¤è´£ä»»**: UltraThinkåºåˆ—åŒ–å›¢é˜Ÿ