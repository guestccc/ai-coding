# Token优化规则 (Token Optimization Rules)

## 规则概述
UltraThink框架v1.3.0的Token优化核心规则集，通过系统化的优化策略实现30-50%的Token使用效率提升。

## 核心优化原则

### P1: 信息密度最大化原则
```yaml
目标: 在最少的Token中传递最多的有效信息
策略:
  - 优先使用技术术语而非描述性语言
  - 采用结构化数据格式替代自然语言
  - 使用符号化映射压缩常用概念
  - 通过引用机制避免内容重复

示例:
原文: "我们需要实现一个基于React框架的前端用户界面，包含用户认证登录功能"
优化: "实现@React前端UI，包含@Auth登录功能"
效果: 35字符 → 18字符 (49%压缩率)
```

### P2: 上下文智能管理原则
```yaml
目标: 动态调整上下文内容，保持相关性最大化
策略:
  - 基于任务相关性动态筛选上下文
  - 使用优先级队列管理信息重要性
  - 自动归档低频访问的历史信息
  - 实施渐进式内容压缩机制

上下文分层:
  L0-立即相关: 当前任务直接相关信息 (100%保留)
  L1-高度相关: 近期任务和重要决策 (80%保留)  
  L2-中度相关: 历史经验和参考资料 (50%保留)
  L3-低度相关: 归档信息和备用资源 (20%保留)
```

### P3: 语义保持压缩原则  
```yaml
目标: 在压缩的同时确保关键语义完整保留
策略:
  - 识别和保护核心语义关键词
  - 使用同义词替换减少重复表达
  - 采用概念抽象提升表达效率
  - 建立语义验证反馈机制

保护机制:
  ✓ 业务逻辑描述必须完整保留
  ✓ 技术决策理由不可省略
  ✓ 错误处理逻辑必须清晰
  ✓ 测试用例要求完整描述
```

## 智能引用系统规则

### R1: 引用创建规则
```yaml
创建条件:
  - 内容长度 ≥ 20字符
  - 重复出现 ≥ 3次
  - 节省Token ≥ 10个
  - 语义完整性 = 100%

引用命名规范:
  文件引用: @[类型][简称] 
    - @PRD (docs/PRD.md)
    - @arch (docs/architecture.md)
    - @api (docs/openapi.yaml)
  
  概念引用: @[领域][概念]
    - @AuthJWT (JWT认证系统)
    - @UserCRUD (用户增删改查)
    - @ErrorHandler (错误处理机制)
  
  代码引用: @[模块][功能]
    - @UserAPI (用户API接口)
    - @DBConfig (数据库配置)
    - @TestSuite (测试套件)
```

### R2: 引用解析规则
```yaml
解析优先级:
  1. 精确匹配: 完全匹配引用标识
  2. 模糊匹配: 基于相似度的最佳匹配
  3. 上下文推断: 根据当前上下文智能推断
  4. 用户确认: 歧义情况下请求用户确认

解析失效处理:
  - 尝试路径修复和文件搜索
  - 提供相似引用推荐建议
  - 回退到原始内容显示
  - 记录失效原因供优化参考
```

### R3: 引用维护规则
```yaml
自动维护:
  - 定期检查引用有效性 (24小时间隔)
  - 自动更新文件路径变更
  - 清理无效和过期引用
  - 统计引用使用频率

手动维护:
  - 支持用户自定义引用
  - 允许引用别名设置
  - 提供引用批量管理
  - 支持引用导入导出
```

## 术语符号化规则

### S1: 符号映射表
```yaml
# 核心技术栈 (出现频率>10次自动映射)
前端技术:
  "React前端应用": "@React"
  "TypeScript类型检查": "@TS"  
  "Tailwind CSS样式": "@Tailwind"
  "Vite构建工具": "@Vite"

后端技术:
  "Express后端服务": "@Express"
  "Node.js运行时": "@Node"
  "Prisma ORM": "@Prisma"
  "PostgreSQL数据库": "@PG"

开发流程:
  "测试驱动开发": "@TDD"
  "持续集成部署": "@CI/CD"
  "代码质量检查": "@QA"
  "性能监控": "@Monitor"

业务概念:
  "用户认证授权": "@Auth"
  "权限管理系统": "@Permission"  
  "数据验证机制": "@Validate"
  "错误处理逻辑": "@Error"
```

### S2: 符号使用规则
```yaml
使用条件:
  - 术语出现频率 ≥ 3次/会话
  - 符号长度 < 原词长度的50%
  - 符号语义明确无歧义
  - 团队成员理解一致性

符号优先级:
  1. 项目专用术语 (最高优先级)
  2. 技术栈相关术语
  3. 通用开发概念
  4. 业务领域术语

符号冲突处理:
  - 优先保留高频使用符号
  - 为冲突符号添加前缀区分
  - 提供符号定义上下文
  - 支持符号动态重映射
```

## 数据压缩规则

### C1: 结构化压缩规则
```yaml
JSON压缩策略:
  键名缩写:
    "taskId" → "id"
    "description" → "desc"  
    "timestamp" → "time"
    "status" → "st"
  
  值优化:
    布尔值: true→✓, false→✗
    状态值: "completed"→"✓", "pending"→"⏳"
    空值清理: null和undefined值自动移除
  
  结构优化:
    数组压缩: 单元素数组展平
    对象合并: 相同结构对象合并
    嵌套优化: 深度>3的嵌套结构平铺
```

### C2: 文本压缩规则  
```yaml
文本优化策略:
  冗余消除:
    - 移除重复的修饰词
    - 合并相似的表达方式
    - 删除过渡性连接词
    - 压缩客套和礼貌用语
  
  表达简化:
    - 用词汇替代短语
    - 用符号替代状态描述
    - 用缩写替代常用术语
    - 用引用替代重复内容

压缩质量控制:
  - 保证核心信息完整性 ≥95%
  - 维持表达清晰度 ≥90%
  - 确保专业术语准确性 100%
  - 支持原文一键恢复
```

## Token预算管理规则

### B1: 预算分配规则
```yaml
总预算分配 (基于100K Token预算):
  核心上下文: 30K (30%)
    - 当前任务描述: 10K
    - 关键决策记录: 10K  
    - 重要问题跟踪: 10K
  
  工作内存: 50K (50%)
    - 当前代码文件: 25K
    - Agent对话记录: 15K
    - 临时工作数据: 10K
    
  历史记录: 15K (15%)
    - 已完成任务记录: 8K
    - 历史决策记录: 4K
    - 经验教训总结: 3K
    
  预留缓冲: 5K (5%)
    - 紧急信息处理: 3K
    - 错误恢复空间: 2K
```

### B2: 动态调整规则
```yaml
调整触发条件:
  - Token使用率 >80%: 启动压缩清理
  - Token使用率 >90%: 强制历史归档  
  - Token使用率 >95%: 紧急内容裁剪
  - 任务阶段切换: 重新分配预算比例

调整策略:
  优先级清理:
    1. 清理临时和缓存数据
    2. 压缩低频访问内容
    3. 归档历史会话数据
    4. 裁剪详细描述信息
  
  智能扩展:
    - 复杂任务增加工作内存分配
    - 新项目减少历史记录分配
    - 调试阶段增加预留缓冲
    - 收尾阶段增加核心上下文
```

## 质量保证规则

### Q1: 压缩质量评估
```yaml
评估维度:
  信息完整性: 压缩后关键信息保留率
  可理解性: 压缩内容的可读性评分
  可恢复性: 原始内容恢复准确度
  压缩效率: Token节省百分比

质量标准:
  - 信息完整性 ≥95%
  - 可理解性 ≥90%  
  - 可恢复性 ≥98%
  - 压缩效率 ≥30%

质量不达标处理:
  - 自动调整压缩参数
  - 回退到较低压缩级别
  - 保护关键信息不压缩
  - 请求用户确认重要变更
```

### Q2: 语义验证规则
```yaml
验证检查点:
  - 压缩前后语义对比验证
  - 关键术语准确性检查
  - 逻辑关系完整性验证
  - 上下文一致性检查

验证失败处理:
  - 标记验证失败的内容
  - 保留原始版本作为备选
  - 提供人工校验选项
  - 更新压缩算法参数
```

## 监控和反馈规则

### M1: 实时监控规则
```yaml
监控指标:
  - Token实时使用量和趋势
  - 压缩效率和质量指标
  - 引用解析成功率统计
  - 用户满意度反馈评分

警告阈值:
  - Token使用率 >75%: 黄色警告
  - Token使用率 >85%: 橙色警告
  - Token使用率 >95%: 红色警告
  - 压缩质量 <90%: 质量警告
```

### M2: 优化建议规则
```yaml
建议触发条件:
  - 检测到重复内容 >5次
  - 发现可优化的长引用
  - 识别到低效的表达模式
  - 发现未使用的历史数据

建议执行策略:
  - 安全优化自动执行
  - 风险优化请求确认
  - 重要变更详细说明
  - 优化效果实时反馈
```

---

**规则版本**: v1.3.0  
**生效日期**: 2024-01-01  
**维护责任**: UltraThink Token优化团队
